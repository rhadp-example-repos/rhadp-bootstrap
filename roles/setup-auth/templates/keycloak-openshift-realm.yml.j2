apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: openshift-realm
  namespace: { { keycloak_namespace } }
spec:
  keycloakCRName: keycloak
  realm:
    realm: openshift
    enabled: true
    displayName: "OpenShift Authentication Realm"
    groups:
      - name: cluster-admins
        path: /cluster-admins
      - name: developers
        path: /developers
    clients:
      - name: openshift
        clientId: openshift
        enabled: true
        standardFlowEnabled: true
        directAccessGrantsEnabled: true
        secret: "{{ keycloak_client_secret }}"
        redirectUris:
          - "https://oauth-openshift.apps.{{ cluster_name }}.{{ cluster_domain }}/oauth2callback/*"
        webOrigins:
          - "https://oauth-openshift.apps.{{ cluster_name }}.{{ cluster_domain }}"
        bearerOnly: false
        publicClient: false
        serviceAccountsEnabled: true
        authorizationServicesEnabled: true
        fullScopeAllowed: true
        protocol: openid-connect
        consentRequired: false
        access:
          view: true
          configure: true
          manage: true
    clientScopes:
      - name: openshift
        protocol: openid-connect
        protocolMappers:
          # Username mapper
          - name: username-mapper
            protocolMapper: oidc-usermodel-attribute-mapper
            config:
              attribute: username
              idToken.claim: true
              accessToken.claim: true
              claim.name: username

          # Email mapper
          - name: email-mapper
            protocolMapper: oidc-usermodel-attribute-mapper
            config:
              attribute: email
              idToken.claim: true
              accessToken.claim: true
              claim.name: email

          # Group membership mapper
          - name: group-mapper
            protocolMapper: oidc-group-membership-mapper
            config:
              id.token.claim: true
              access.token.claim: true
              claim.name: groups
              full.path: true
    users:
      - username: developer
        email: developer@{{ cluster_domain }}
        emailVerified: true
        enabled: true
        firstName: Dev
        lastName: Null
        credentials:
          - type: password
            value: "developer"
            temporary: true
        realmRoles:
          - default-roles-openshift
        groups:
          - developers
